AWSTemplateFormatVersion: "2010-09-09"
Transform: AWS::Serverless-2016-10-31
Description: Serverless patterns - Backup CodeCommit to S3 using EventBridge and CodeBuild

Parameters:
  PageDomain:
    Type: String
    Default: test-bucket-name-hosted.host

Resources:
  # private CodeCommit repository
  CodeCommitRepo:
    Type: AWS::CodeCommit::Repository
    Properties:
      RepositoryName: !Sub ${PageDomain}-repo
      RepositoryDescription: This is a repository for the webApp build

  # private s3 bucket
  S3Bucket:
    Type: AWS::S3::Bucket
    Description: Bucket for the builds
    Properties:
      VersioningConfiguration:
        Status: Enabled
      AccessControl: Private

  # Bucket that will store the CodeCommit backups
  CodeCommitBackupBucket:
    Type: 'AWS::S3::Bucket'
    Description: Bucket to store CodeCommit code
    Properties:
      OwnershipControls:
        Rules:
          - ObjectOwnership: BucketOwnerEnforced

  # Role with permisions for the CodeBuild project
  CodeBuildRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
            - Effect: Allow
              Principal:
                  Service:
                    - codebuild.amazonaws.com
              Action:
                - sts:AssumeRole
      Description: !Sub "IAM Role for ${AWS::StackName}"
      Path: '/'
      Policies:
        - PolicyName: root
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Action:
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                  - codecommit:GitPull
                  - s3:Get*
                  - s3:List*
                  - s3:PutObject
                Effect: Allow
                Resource: '*'

  # Project that clones the CodeCommit repository, compress the files in a .zip and uploads to S3              
  CodeBuildProject:
    Type: AWS::CodeBuild::Project
    Properties:
      Description: CodeBuild project to sync CodeCommit repositories to S3 on backup account
      ServiceRole: !GetAtt CodeBuildRole.Arn
      Artifacts:
        Type: NO_ARTIFACTS
      Environment:
        Type: LINUX_CONTAINER
        ComputeType: BUILD_GENERAL1_SMALL
        Image: aws/codebuild/standard:4.0
        EnvironmentVariables:
          - Name: BUCKET
            Value: !Ref S3Bucket
            Type: PLAINTEXT
          - Name: ACCOUNT
            Value: !Sub ${AWS::AccountId}
            Type: PLAINTEXT
      Source:
        Location: !Join
          - ''
          - - !Ref CodeCommitBackupBucket
            - '/codebuild-source/'
        Type: S3
      TimeoutInMinutes: 10

  # Lambda function to create the buildspec.yml in the CodeCommitBackupBucket 
  CreateBuildspec:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: functions/
      Handler: index.handler
      Runtime: python3.9
      Environment:
        Variables:
          bucket: !Ref CodeCommitBackupBucket
      Policies:
        - AWSLambdaExecute
        - Version: '2012-10-17' 
          Statement:
            - Effect: Allow
              Action:
                - s3:PutObject
              Resource: !Join                                                                                       
                - ''
                - - 'arn:aws:s3:::'
                  - !Ref CodeCommitBackupBucket
                  - '/*'

  # Custom resource to trigger the Lambda function at deployment time
  TriggerBuildspecCreation:
    Type: AWS::CloudFormation::CustomResource
    DependsOn: CreateBuildspec
    Version: "1.0"
    Properties:
      ServiceToken: !GetAtt CreateBuildspec.Arn

  # Role for the event 
  EventRole:
    Description: IAM role to allow Amazon CloudWatch Events to trigger AWS CodeBuild build
    Properties:
      AssumeRolePolicyDocument:
        Statement:
        - Action: sts:AssumeRole
          Effect: Allow
          Principal:
            Service:
            - events.amazonaws.com
          Sid: 1
      Policies:
      - PolicyDocument:
          Statement:
          - Action:
            - codebuild:StartBuild
            Effect: Allow
            Resource: !GetAtt 'CodeBuildProject.Arn'
        PolicyName: !Join
          - '-'
          - - !Ref 'AWS::StackName'
            - CloudWatchEventPolicy
      RoleName: !Join
        - '-'
        - - !Ref 'AWS::StackName'
          - CloudWatchEventRule
    Type: AWS::IAM::Role

  # Event that triggers the CodeBuild when the content of a CodeCommit repository is modified 
  EventRule:
    Type: "AWS::Events::Rule"
    Properties:
      Description: "EventRule"
      EventPattern:
        source:
        - aws.codecommit
        resources:
        - !GetAtt CodeCommitRepo.Arn
        detail-type:
        - CodeCommit Repository State Change
        detail:
          event:
          - referenceUpdated
      State: "ENABLED"
      Targets:
        - Arn: !GetAtt 'CodeBuildProject.Arn'
          Id: CodeCommit2S3
          RoleArn: !GetAtt 'EventRole.Arn'
          InputTransformer:
            InputPathsMap: 
              "referenceType": "$.detail.referenceType"
              "region": "$.region"
              "repositoryName": "$.detail.repositoryName"
              "account": "$.account"
              "referenceName": "$.detail.referenceName"
            InputTemplate: |
              {"environmentVariablesOverride": [{"name": "REFERENCE_NAME","value": <referenceName>},{"name": "REFERENCE_TYPE","value": <referenceType>},{"name": "REPOSITORY_NAME","value": <repositoryName>},{"name": "REPO_REGION","value": <region>},{"name": "ACCOUNT_ID","value": <account>}]}

# CloudFront distribution origin access identity to connece with S3 bucket
  CloudFrontOriginAccessIdentity:
    Type: AWS::CloudFront::CloudFrontOriginAccessIdentity
    Properties:
      CloudFrontOriginAccessIdentityConfig:
        Comment: CloudFront OAI for s3

  # CloudFront Distribution
  PublicDistribution:
    Type: AWS::CloudFront::Distribution
    Properties:
      DistributionConfig:
        Origins:
          - DomainName: !GetAtt S3Bucket.DomainName
            Id: S3-build-bucket
            S3OriginConfig:
              OriginAccessIdentity:
                !Join ['', ['origin-access-identity/cloudfront/', !Ref CloudFrontOriginAccessIdentity]]
        Enabled: true
        HttpVersion: 'http2'
        DefaultRootObject: 'index.html'
        IPV6Enabled: true
        Comment: CloudFront distribution
        DefaultCacheBehavior:
          DefaultTTL: 86400
          MaxTTL: 31536000
          TargetOriginId: !Sub 'S3-${AWS::StackName}-root'
          AllowedMethods:
            - GET
            - HEAD
          TargetOriginId: S3-build-bucket
          ForwardedValues:
            QueryString: true
            Cookies:
              Forward: none
          ViewerProtocolPolicy: redirect-to-https
        ViewerCertificate:
          CloudFrontDefaultCertificate: 'true'
        PriceClass: 'PriceClass_200'

  # Policy to enable public read
  BucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref S3Bucket
      PolicyDocument:
        Version: 2012-10-17
        Statement:
          - Action:
              - s3:GetObject
            Effect: Allow
            Resource: 
              !Sub
                - ${bucketArn}/*
                - bucketArn: !GetAtt S3Bucket.Arn
            Principal:
              CanonicalUser: !GetAtt CloudFrontOriginAccessIdentity.S3CanonicalUserId


Outputs:
  CodeCommitBackupBucket:
    Description: "Bucket to store the CodeCommit backup files"
    Value:
      Ref: CodeCommitBackupBucket              