AWSTemplateFormatVersion: 2010-09-09
Transform: AWS::Serverless-2016-10-31
Description: Serverless - Deploy webApp build into s3 bucket

Parameters:
  PageDomain:
    Type: String
    Default: test-bucket-name-hosted.host

Resources:
  # Resource stack for CloudFront fronting S3 bucket with an index.html
  CloudFrontS3SiteStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: ./s3-cloudfront-private-site.yaml
      Parameters: 
        PageDomain: !Ref PageDomain

  # CodeCommit repository stack
  CodeCommitRepoStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: ./codecommit-lambda.yaml
      Parameters: 
        RepoName: !Sub ${PageDomain}-repo
        S3BucketName: !GetAtt CloudFrontS3SiteStack.Outputs.S3PrivateBucketName
        CoveredBranch: master

Outputs:
  CloudFrontDomainName:
    Description: Website address
    Value: !GetAtt CloudFrontS3SiteStack.Outputs.PublicDistributionDomain

      

# insert certificate arn into cloudfront
# sam.cmd deploy --capabilities CAPABILITY_NAMED_IAM CAPABILITY_AUTO_EXPAND --template template.yaml
# script
# s3 with host
# s3 fornted by cloudfront and certificate
# s3 fed by codecommit